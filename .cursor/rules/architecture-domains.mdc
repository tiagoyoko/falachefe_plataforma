---
description: Arquitetura de dom√≠nios e separa√ß√£o de responsabilidades
---
# Arquitetura de Dom√≠nios - FalaChefe

## üåê Dois Dom√≠nios Distintos

### 1. falachefe.app.br (Vercel)
**Tecnologia**: Next.js 15 + React 19  
**Hospedagem**: Vercel  
**Fun√ß√£o**: Frontend + Backend API + Webhooks

**Endpoints principais**:
- `GET /` - Homepage
- `GET /dashboard` - Dashboard
- `GET /chat` - Chat web
- `POST /api/webhook/uaz` - Webhook WhatsApp
- `POST /api/auth/*` - Autentica√ß√£o
- `POST /api/financial/crewai` - API financeira (a criar)

**Vari√°veis**:
```bash
NEXT_PUBLIC_APP_URL=https://falachefe.app.br
CREWAI_API_URL=https://api.falachefe.app.br  # ‚ö†Ô∏è Com "api."
```

### 2. api.falachefe.app.br (Hetzner)
**Tecnologia**: Python + CrewAI + Flask  
**Hospedagem**: Hetzner (Docker Swarm + Traefik)  
**IP**: 37.27.248.13  
**Fun√ß√£o**: Processamento IA (Agentes CrewAI)

**Endpoints principais**:
- `GET /health` - Health check
- `POST /process` - Processar mensagem texto
- `POST /process-audio` - Processar √°udio
- `POST /process-image` - Processar imagem
- `GET /metrics` - M√©tricas Prometheus

**Vari√°veis**:
```bash
FALACHEFE_API_URL=https://falachefe.app.br  # ‚ö†Ô∏è SEM "api."
OPENAI_API_KEY=***
```

## üîÑ Fluxo de Comunica√ß√£o

```
WhatsApp ‚Üí UAZAPI
    ‚Üì
Webhook: https://falachefe.app.br/api/webhook/uaz (Vercel)
    ‚Üì
MessageRouter valida usu√°rio e empresa
    ‚Üì
HTTP POST: https://api.falachefe.app.br/process (Hetzner)
    ‚Üì
CrewAI processa (agentes especializados)
    ‚Üì
Resposta ‚Üí Vercel
    ‚Üì
Envio para WhatsApp via UAZAPI
    ‚Üì
WhatsApp ‚Üí Usu√°rio
```

## ‚öôÔ∏è Configura√ß√µes por Ambiente

### DNS

| Registro | Tipo | Valor | TTL |
|----------|------|-------|-----|
| `falachefe.app.br` | CNAME | `cname.vercel-dns.com` | 3600 |
| `api.falachefe.app.br` | A | `37.27.248.13` | 3600 |

### SSL/TLS

| Dom√≠nio | Provedor | Status |
|---------|----------|--------|
| `falachefe.app.br` | Vercel (auto) | ‚úÖ |
| `api.falachefe.app.br` | Let's Encrypt (Traefik) | ‚úÖ |

### Deploy

**Vercel (autom√°tico)**:
```bash
git push origin master  # Auto-deploy
```

**Hetzner (manual)**:
```bash
ssh root@37.27.248.13
cd /opt/falachefe-crewai
docker build -t falachefe-crewai:latest .
docker service update --image falachefe-crewai:latest falachefe_crewai-api
```

## üö® Erros Comuns

### ‚ùå URL errada no c√≥digo

```typescript
// ERRADO
const url = 'https://falachefe.app.br/process'  // Missing "api."

// CERTO
const url = 'https://api.falachefe.app.br/process'
```

### ‚ùå Vari√°vel de ambiente errada

```bash
# ERRADO - No Vercel
CREWAI_API_URL=https://falachefe.app.br  # Missing "api."

# CERTO
CREWAI_API_URL=https://api.falachefe.app.br
```

### ‚ùå Confundir endpoints

```typescript
// ERRADO - CrewAI chamar pr√≥prio dom√≠nio
const url = process.env.CREWAI_API_URL  // ‚ùå api.falachefe.app.br

// CERTO - CrewAI chamar Vercel
const url = process.env.FALACHEFE_API_URL  // ‚úÖ falachefe.app.br
```

## üìã Checklist de Valida√ß√£o

Ao fazer mudan√ßas que envolvem comunica√ß√£o entre dom√≠nios:

- [ ] URL est√° correta? (`api.` ou n√£o?)
- [ ] Vari√°vel de ambiente est√° correta?
- [ ] CORS permite o dom√≠nio?
- [ ] Token de autentica√ß√£o est√° configurado?
- [ ] Testou com `curl` manual?

Veja [ARQUITETURA-DOMINIOS.md](mdc:ARQUITETURA-DOMINIOS.md) para detalhes completos.
