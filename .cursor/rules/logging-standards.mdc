---
globs: *.ts,*.tsx,*.js,*.py
description: PadrÃµes de logging e observabilidade
---
# PadrÃµes de Logging - FalaChefe

## ğŸ¯ Objetivo

Logs devem permitir **debug rÃ¡pido** e **rastreamento completo** de operaÃ§Ãµes.

## ğŸ“ Formato PadrÃ£o (TypeScript/JavaScript)

### Estrutura de Log

```typescript
console.log('ğŸ”µ [Componente] AÃ§Ã£o:', {
  dados: 'relevantes',
  contexto: 'necessÃ¡rio',
  timestamp: new Date().toISOString()
});
```

### Emojis por Tipo

| Emoji | Tipo | Uso |
|-------|------|-----|
| ğŸ”µ | Info | InÃ­cio de operaÃ§Ã£o |
| âœ… | Success | OperaÃ§Ã£o bem-sucedida |
| âš ï¸  | Warning | Algo inesperado mas nÃ£o crÃ­tico |
| âŒ | Error | Erro que precisa atenÃ§Ã£o |
| ğŸ“¤ | Request | Envio de request HTTP |
| ğŸ“¥ | Response | Recebimento de response |
| ğŸ’¾ | Database | OperaÃ§Ã£o de banco de dados |
| ğŸ” | Auth | AutenticaÃ§Ã£o/AutorizaÃ§Ã£o |
| ğŸªŸ | Business | LÃ³gica de negÃ³cio |

### Exemplos PrÃ¡ticos

#### âœ… BOM - Request HTTP

```typescript
console.log('ğŸ“¤ Sending request to CrewAI:', {
  endpoint: 'https://api.falachefe.app.br/process',
  timeout: '180000ms',
  payloadSize: JSON.stringify(payload).length,
  userId: payload.userId
});

const response = await fetch(endpoint, options);

console.log('ğŸ“¥ CrewAI response received:', {
  status: response.status,
  ok: response.ok,
  processingTime: Date.now() - startTime
});

const data = await response.json();

console.log('âœ… Processing succeeded:', {
  hasResponse: !!data.response,
  responseLength: data.response?.length,
  metadata: data.metadata
});
```

#### âœ… BOM - OperaÃ§Ã£o de Banco

```typescript
console.log('ğŸ’¾ Saving message to database:', {
  conversationId,
  userId,
  messageLength: content.length
});

const result = await db.execute(sql`...`);

console.log('âœ… Message saved:', {
  messageId: result[0].id,
  conversationId,
  timestamp: result[0].created_at
});
```

#### âœ… BOM - Error Handling

```typescript
try {
  // operaÃ§Ã£o
} catch (error) {
  console.error('âŒ Operation failed:', {
    operation: 'processMessage',
    error: error instanceof Error ? error.message : 'Unknown',
    context: {
      userId,
      messageId,
      timestamp: new Date().toISOString()
    },
    stack: error instanceof Error ? error.stack : undefined
  });
  
  // Re-lanÃ§ar ou tratar
}
```

#### âŒ RUIM - Log Vago

```typescript
// âŒ NÃ£o faÃ§a isso
console.log('Processing...');
console.log('Done');
console.log('Error:', error);
```

## ğŸ Formato Python

### Estrutura

```python
import logging
from datetime import datetime

# Configurar logger
logger = logging.getLogger(__name__)

# Log com contexto
logger.info('ğŸ“¤ Sending to OpenAI', extra={
    'user_id': user_id,
    'message_length': len(message),
    'model': 'gpt-4o-mini'
})

logger.info('âœ… OpenAI response received', extra={
    'tokens': response.usage.total_tokens,
    'processing_time_ms': processing_time
})
```

## ğŸ” Rastreamento de OperaÃ§Ãµes

### IDs de Rastreamento

```typescript
// Gerar ID Ãºnico para operaÃ§Ã£o
const operationId = `msg-${Date.now()}-${Math.random().toString(36).slice(2)}`;

console.log('ğŸ”µ [Operation Start]:', {
  operationId,
  type: 'process_message',
  userId,
  timestamp: new Date().toISOString()
});

// Incluir operationId em TODOS os logs relacionados
console.log('ğŸ“¤ Sending to CrewAI:', { operationId, endpoint });
console.log('âœ… Operation completed:', { operationId, duration });
```

### Contexto Sempre Presente

Incluir **SEMPRE**:
- `userId` ou `companyId` (quem)
- `messageId` ou `conversationId` (o quÃª)
- `timestamp` (quando)
- `operationId` (rastreamento)

## ğŸ“Š NÃ­veis de Log

| NÃ­vel | Quando Usar |
|-------|-------------|
| **DEBUG** | Detalhes internos (desenvolvimento) |
| **INFO** | OperaÃ§Ãµes normais (produÃ§Ã£o) |
| **WARN** | Algo inesperado mas recuperÃ¡vel |
| **ERROR** | Erro que precisa atenÃ§Ã£o |

### ConfiguraÃ§Ã£o por Ambiente

```typescript
// .env.local (dev)
LOG_LEVEL=debug

// .env.production
LOG_LEVEL=info
```

## ğŸš« O Que NÃƒO Logar

âŒ **Nunca** logar:
- Senhas ou tokens completos
- Dados sensÃ­veis de cartÃ£o
- PII sem mascaramento

âœ… **Use**:
```typescript
// âŒ RUIM
console.log('Token:', process.env.UAZAPI_TOKEN);

// âœ… BOM
console.log('Token:', `***${process.env.UAZAPI_TOKEN?.slice(-4)}`);
```

## ğŸ“ˆ Monitoramento

### Logs que Facilitam Debug

```typescript
// InÃ­cio do fluxo
console.log('ğŸ”µ [Webhook] Received:', {
  eventType,
  messageId,
  from,
  timestamp
});

// ValidaÃ§Ãµes
console.log('ğŸ” [Auth] User validated:', { userId, hasCompany });

// Processamento
console.log('ğŸ“¤ [CrewAI] Request sent:', { endpoint, timeout });
console.log('ğŸ“¥ [CrewAI] Response:', { status, processingTime });

// FinalizaÃ§Ã£o
console.log('âœ… [Webhook] Completed:', {
  messageId,
  totalTime,
  responseSent: true
});
```

### Busca Eficiente

Logs bem estruturados permitem:

```bash
# Buscar por usuÃ¡rio
vercel logs | grep "userId.*or3ZL1Ea1Pm7wFhufyFaRs7y2ZLKLQNb"

# Buscar por operaÃ§Ã£o
vercel logs | grep "operationId.*msg-1697280000000"

# Buscar erros
vercel logs | grep "âŒ"
```

## âœ… Checklist de Log

Antes de commit, garantir que cÃ³digo tem:

- [ ] Log no inÃ­cio da operaÃ§Ã£o
- [ ] Log de dados importantes (mascarados se sensÃ­veis)
- [ ] Log de resultado/sucesso
- [ ] Log de erros com contexto completo
- [ ] IDs de rastreamento quando aplicÃ¡vel
- [ ] Timestamps em operaÃ§Ãµes longas

Veja exemplos em [route.ts](mdc:src/app/api/webhook/uaz/route.ts) (funÃ§Ã£o `processMessageAsync`).
