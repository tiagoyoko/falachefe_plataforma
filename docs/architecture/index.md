# Falachefe CrewAI Architecture Document

## Table of Contents

- [Falachefe CrewAI Architecture Document](#table-of-contents)
  - [Introduction](./introduction.md)
    - [Starter Template ou Projeto Existente](./introduction.md#starter-template-ou-projeto-existente)
    - [Risk Assessment Summary](./introduction.md#risk-assessment-summary)
    - [Change Log](./introduction.md#change-log)
  - [High Level Architecture](./high-level-architecture.md)
    - [Technical Summary](./high-level-architecture.md#technical-summary)
    - [High Level Overview](./high-level-architecture.md#high-level-overview)
    - [High Level Project Diagram](./high-level-architecture.md#high-level-project-diagram)
    - [Architectural and Design Patterns](./high-level-architecture.md#architectural-and-design-patterns)
    - [Constraint Analysis Summary](./high-level-architecture.md#constraint-analysis-summary)
  - [Tech Stack](./tech-stack.md)
    - [Cloud Infrastructure](./tech-stack.md#cloud-infrastructure)
    - [Technology Stack Table](./tech-stack.md#technology-stack-table)
  - [Data Models](./data-models.md)
    - [Crew](./data-models.md#crew)
    - [CrewAgent](./data-models.md#crewagent)
    - [CrewTask](./data-models.md#crewtask)
    - [CrewMemory](./data-models.md#crewmemory)
    - [CrewMetrics](./data-models.md#crewmetrics)
  - [Components](./components.md)
    - [CrewAI Orchestrator](./components.md#crewai-orchestrator)
    - [Message Router](./components.md#message-router)
    - [Financial Agent](./components.md#financial-agent)
    - [Handoff System](./components.md#handoff-system)
    - [Crew Memory System](./components.md#crew-memory-system)
    - [Metrics Collector](./components.md#metrics-collector)
    - [UAZ Integration Handler](./components.md#uaz-integration-handler)
    - [Tenant Isolation Manager](./components.md#tenant-isolation-manager)
    - [Configuration Manager](./components.md#configuration-manager)
    - [Error Handling & Recovery](./components.md#error-handling-recovery)
    - [Component Diagrams](./components.md#component-diagrams)
    - [Technology Trend Analysis Summary](./components.md#technology-trend-analysis-summary)
    - [Rationale Detalhada:](./components.md#rationale-detalhada)
  - [External APIs](./external-apis.md)
    - [UAZ API](./external-apis.md#uaz-api)
    - [OpenAI API](./external-apis.md#openai-api)
    - [Supabase API](./external-apis.md#supabase-api)
    - [Redis API (Redis Cloud)](./external-apis.md#redis-api-redis-cloud)
    - [Sentry API](./external-apis.md#sentry-api)
    - [Vercel Analytics API](./external-apis.md#vercel-analytics-api)
  - [Core Workflows](./core-workflows.md)
    - [Workflow 1: Processamento de Mensagem WhatsApp](./core-workflows.md#workflow-1-processamento-de-mensagem-whatsapp)
    - [Workflow 2: Handoff entre Agentes](./core-workflows.md#workflow-2-handoff-entre-agentes)
    - [Workflow 3: Sistema de Mem√≥ria e Aprendizado](./core-workflows.md#workflow-3-sistema-de-memria-e-aprendizado)
  - [Database Schema](./database-schema.md)
    - [Novas Tabelas CrewAI](./database-schema.md#novas-tabelas-crewai)
    - [√çndices para Performance](./database-schema.md#ndices-para-performance)
    - [Tabelas Adaptadas](./database-schema.md#tabelas-adaptadas)
    - [Row Level Security (RLS)](./database-schema.md#row-level-security-rls)
  - [Source Tree](./source-tree.md)
    - [Estrutura de Diret√≥rios Proposta](./source-tree.md#estrutura-de-diretrios-proposta)
    - [Organiza√ß√£o por Responsabilidades](./source-tree.md#organizao-por-responsabilidades)
      - [üîê Autentica√ß√£o ()](./source-tree.md#autenticao)
      - [ü§ñ CrewAI ()](./source-tree.md#crewai)
      - [üóÑÔ∏è Dados ()](./source-tree.md#dados)
      - [üîå Integra√ß√µes ()](./source-tree.md#integraes)
      - [‚öôÔ∏è Configura√ß√£o ()](./source-tree.md#configurao)
    - [Estrutura de APIs ()](./source-tree.md#estrutura-de-apis)
    - [Componentes de Interface ()](./source-tree.md#componentes-de-interface)
    - [Scripts de Automa√ß√£o ()](./source-tree.md#scripts-de-automao)
    - [Testes Organizados ()](./source-tree.md#testes-organizados)
    - [Documenta√ß√£o Estruturada ()](./source-tree.md#documentao-estruturada)
    - [Benef√≠cios desta Estrutura](./source-tree.md#benefcios-desta-estrutura)
  - [Deployment](./deployment.md)
    - [Estrat√©gia de Deploy Multi-Ambiente](./deployment.md#estratgia-de-deploy-multi-ambiente)
      - [Ambientes de Deploy](./deployment.md#ambientes-de-deploy)
    - [1. Configura√ß√£o Docker](./deployment.md#1-configurao-docker)
      - [Dockerfile Otimizado](./deployment.md#dockerfile-otimizado)
      - [Docker Compose para Desenvolvimento](./deployment.md#docker-compose-para-desenvolvimento)
    - [2. Configura√ß√£o Vercel](./deployment.md#2-configurao-vercel)
      - [vercel.json](./deployment.md#verceljson)
      - [Environment Variables por Ambiente](./deployment.md#environment-variables-por-ambiente)
    - [3. Configura√ß√£o Supabase](./deployment.md#3-configurao-supabase)
      - [Database Migrations](./deployment.md#database-migrations)
    - [4. Configura√ß√£o Redis Cloud](./deployment.md#4-configurao-redis-cloud)
      - [Redis Configuration](./deployment.md#redis-configuration)
    - [5. CI/CD Pipeline](./deployment.md#5-cicd-pipeline)
      - [GitHub Actions Workflow](./deployment.md#github-actions-workflow)
    - [6. Scripts de Deploy](./deployment.md#6-scripts-de-deploy)
      - [Deploy Script para Desenvolvimento](./deployment.md#deploy-script-para-desenvolvimento)
      - [Deploy Script para Produ√ß√£o](./deployment.md#deploy-script-para-produo)
    - [7. Monitoramento e Observabilidade](./deployment.md#7-monitoramento-e-observabilidade)
      - [Health Check Endpoint](./deployment.md#health-check-endpoint)
      - [Cron Jobs para Limpeza](./deployment.md#cron-jobs-para-limpeza)
    - [8. Configura√ß√£o de Dom√≠nio e SSL](./deployment.md#8-configurao-de-domnio-e-ssl)
      - [Nginx Configuration](./deployment.md#nginx-configuration)
    - [9. Rollback Strategy](./deployment.md#9-rollback-strategy)
      - [Rollback Script](./deployment.md#rollback-script)
    - [10. Environment-Specific Configurations](./deployment.md#10-environment-specific-configurations)
      - [Configura√ß√£o por Ambiente](./deployment.md#configurao-por-ambiente)
    - [Benef√≠cios da Estrat√©gia de Deploy](./deployment.md#benefcios-da-estratgia-de-deploy)
  - [Monitoring](./monitoring.md)
    - [Estrat√©gia de Observabilidade Completa](./monitoring.md#estratgia-de-observabilidade-completa)
      - [Stack de Monitoramento](./monitoring.md#stack-de-monitoramento)
    - [1. M√©tricas de Aplica√ß√£o](./monitoring.md#1-mtricas-de-aplicao)
      - [Sistema de M√©tricas WhatsApp Auth](./monitoring.md#sistema-de-mtricas-whatsapp-auth)
      - [Sistema de M√©tricas CrewAI](./monitoring.md#sistema-de-mtricas-crewai)
    - [2. Sistema de Logging Estruturado](./monitoring.md#2-sistema-de-logging-estruturado)
      - [Logger Centralizado](./monitoring.md#logger-centralizado)
      - [Logs Estruturados para WhatsApp Auth](./monitoring.md#logs-estruturados-para-whatsapp-auth)
      - [Logs Estruturados para CrewAI](./monitoring.md#logs-estruturados-para-crewai)
    - [3. Distributed Tracing](./monitoring.md#3-distributed-tracing)
      - [Configura√ß√£o Jaeger](./monitoring.md#configurao-jaeger)
      - [Instrumenta√ß√£o WhatsApp Auth](./monitoring.md#instrumentao-whatsapp-auth)
    - [4. Dashboards Grafana](./monitoring.md#4-dashboards-grafana)
      - [Dashboard WhatsApp Auth](./monitoring.md#dashboard-whatsapp-auth)
      - [Dashboard CrewAI](./monitoring.md#dashboard-crewai)
    - [5. Sistema de Alertas](./monitoring.md#5-sistema-de-alertas)
      - [Configura√ß√£o de Alertas](./monitoring.md#configurao-de-alertas)
    - [6. Health Checks Avan√ßados](./monitoring.md#6-health-checks-avanados)
      - [Health Check Completo](./monitoring.md#health-check-completo)
    - [7. M√©tricas de Business Intelligence](./monitoring.md#7-mtricas-de-business-intelligence)
      - [M√©tricas de Neg√≥cio](./monitoring.md#mtricas-de-negcio)
    - [8. Integra√ß√£o com Sentry](./monitoring.md#8-integrao-com-sentry)
      - [Configura√ß√£o Sentry](./monitoring.md#configurao-sentry)
    - [Benef√≠cios do Sistema de Monitoramento](./monitoring.md#benefcios-do-sistema-de-monitoramento)
  - [Security](./security.md)
    - [Estrat√©gia de Seguran√ßa Baseada em Better Auth + RBAC](./security.md#estratgia-de-segurana-baseada-em-better-auth-rbac)
      - [Hierarquia de Roles e Permiss√µes](./security.md#hierarquia-de-roles-e-permisses)
    - [1. Configura√ß√£o Better Auth com RBAC](./security.md#1-configurao-better-auth-com-rbac)
      - [Configura√ß√£o Principal do Better Auth](./security.md#configurao-principal-do-better-auth)
      - [Sistema de Roles e Permiss√µes](./security.md#sistema-de-roles-e-permisses)
      - [Middleware de Autentica√ß√£o e Autoriza√ß√£o](./security.md#middleware-de-autenticao-e-autorizao)
    - [2. Prote√ß√£o Multi-Tenant](./security.md#2-proteo-multi-tenant)
      - [Middleware de Isolamento por Empresa](./security.md#middleware-de-isolamento-por-empresa)
    - [3. Prote√ß√£o de APIs](./security.md#3-proteo-de-apis)
      - [Prote√ß√£o de Endpoints WhatsApp Auth](./security.md#proteo-de-endpoints-whatsapp-auth)
      - [Prote√ß√£o de Endpoints CrewAI](./security.md#proteo-de-endpoints-crewai)
      - [Prote√ß√£o de Endpoints Admin](./security.md#proteo-de-endpoints-admin)
    - [4. Prote√ß√£o de Dados Sens√≠veis](./security.md#4-proteo-de-dados-sensveis)
      - [Sanitiza√ß√£o de Dados](./security.md#sanitizao-de-dados)
      - [Valida√ß√£o de Input](./security.md#validao-de-input)
    - [5. Prote√ß√£o de Rate Limiting](./security.md#5-proteo-de-rate-limiting)
      - [Rate Limiting por Role e Endpoint](./security.md#rate-limiting-por-role-e-endpoint)
    - [6. Auditoria e Compliance](./security.md#6-auditoria-e-compliance)
      - [Sistema de Auditoria](./security.md#sistema-de-auditoria)
    - [7. Configura√ß√£o de Seguran√ßa do Next.js](./security.md#7-configurao-de-segurana-do-nextjs)
      - [Middleware de Seguran√ßa](./security.md#middleware-de-segurana)
    - [8. Configura√ß√£o de Usu√°rios Espec√≠ficos](./security.md#8-configurao-de-usurios-especficos)
      - [Script de Inicializa√ß√£o de Usu√°rios](./security.md#script-de-inicializao-de-usurios)
    - [Benef√≠cios da Estrat√©gia de Seguran√ßa](./security.md#benefcios-da-estratgia-de-segurana)
  - [Performance](./performance.md)
    - [Estrat√©gia de Otimiza√ß√£o e Escalabilidade](./performance.md#estratgia-de-otimizao-e-escalabilidade)
      - [Arquitetura de Performance](./performance.md#arquitetura-de-performance)
    - [1. Otimiza√ß√µes de Banco de Dados](./performance.md#1-otimizaes-de-banco-de-dados)
      - [Estrat√©gia de Indexa√ß√£o](./performance.md#estratgia-de-indexao)
      - [Configura√ß√£o de Connection Pooling](./performance.md#configurao-de-connection-pooling)
      - [Otimiza√ß√£o de Queries](./performance.md#otimizao-de-queries)
    - [2. Cache Strategy](./performance.md#2-cache-strategy)
      - [Sistema de Cache Multi-Camada](./performance.md#sistema-de-cache-multi-camada)
      - [Cache Invalidation Strategy](./performance.md#cache-invalidation-strategy)
    - [3. Otimiza√ß√£o de APIs](./performance.md#3-otimizao-de-apis)
      - [API Response Optimization](./performance.md#api-response-optimization)
      - [Request Batching](./performance.md#request-batching)
    - [4. Background Jobs e Queue System](./performance.md#4-background-jobs-e-queue-system)
      - [Sistema de Queue Otimizado](./performance.md#sistema-de-queue-otimizado)
      - [Background Job Optimization](./performance.md#background-job-optimization)
    - [5. CDN e Asset Optimization](./performance.md#5-cdn-e-asset-optimization)
      - [CDN Configuration](./performance.md#cdn-configuration)
    - [6. Database Performance Monitoring](./performance.md#6-database-performance-monitoring)
      - [Query Performance Monitoring](./performance.md#query-performance-monitoring)
    - [7. Auto-scaling e Load Balancing](./performance.md#7-auto-scaling-e-load-balancing)
      - [Auto-scaling Configuration](./performance.md#auto-scaling-configuration)
    - [Benef√≠cios da Estrat√©gia de Performance](./performance.md#benefcios-da-estratgia-de-performance)
  - [Testing Strategy](./testing-strategy.md)
    - [Estrat√©gia Abrangente de Testes](./testing-strategy.md#estratgia-abrangente-de-testes)
      - [Pir√¢mide de Testes](./testing-strategy.md#pirmide-de-testes)
    - [1. Testes Unit√°rios](./testing-strategy.md#1-testes-unitrios)
      - [Configura√ß√£o Jest para CrewAI](./testing-strategy.md#configurao-jest-para-crewai)
      - [Testes de Autentica√ß√£o WhatsApp](./testing-strategy.md#testes-de-autenticao-whatsapp)
      - [Testes do Sistema CrewAI](./testing-strategy.md#testes-do-sistema-crewai)
    - [2. Testes de Integra√ß√£o](./testing-strategy.md#2-testes-de-integrao)
      - [Configura√ß√£o de Testes de Integra√ß√£o](./testing-strategy.md#configurao-de-testes-de-integrao)
      - [Testes de API Integration](./testing-strategy.md#testes-de-api-integration)
      - [Testes de Database Integration](./testing-strategy.md#testes-de-database-integration)
    - [3. Testes End-to-End](./testing-strategy.md#3-testes-end-to-end)
      - [Configura√ß√£o Playwright](./testing-strategy.md#configurao-playwright)
      - [Testes E2E WhatsApp Auth Flow](./testing-strategy.md#testes-e2e-whatsapp-auth-flow)
      - [Testes E2E CrewAI Workflow](./testing-strategy.md#testes-e2e-crewai-workflow)
    - [4. Testes de Performance](./testing-strategy.md#4-testes-de-performance)
      - [Configura√ß√£o K6](./testing-strategy.md#configurao-k6)
      - [Testes de Load CrewAI](./testing-strategy.md#testes-de-load-crewai)
    - [5. Testes de Seguran√ßa](./testing-strategy.md#5-testes-de-segurana)
      - [Configura√ß√£o OWASP ZAP](./testing-strategy.md#configurao-owasp-zap)
      - [Testes de Seguran√ßa Customizados](./testing-strategy.md#testes-de-segurana-customizados)
    - [6. Testes de Acessibilidade](./testing-strategy.md#6-testes-de-acessibilidade)
      - [Configura√ß√£o Axe](./testing-strategy.md#configurao-axe)
    - [7. CI/CD Pipeline de Testes](./testing-strategy.md#7-cicd-pipeline-de-testes)
      - [GitHub Actions](./testing-strategy.md#github-actions)
    - [8. Scripts de Teste](./testing-strategy.md#8-scripts-de-teste)
      - [Package.json Scripts](./testing-strategy.md#packagejson-scripts)
    - [Benef√≠cios da Estrat√©gia de Testes](./testing-strategy.md#benefcios-da-estratgia-de-testes)
  - [Development Workflow](./development-workflow.md)
    - [Fluxo de Desenvolvimento Completo](./development-workflow.md#fluxo-de-desenvolvimento-completo)
      - [Fluxo de Desenvolvimento](./development-workflow.md#fluxo-de-desenvolvimento)
    - [1. Configura√ß√£o do Ambiente de Desenvolvimento](./development-workflow.md#1-configurao-do-ambiente-de-desenvolvimento)
      - [Setup Inicial](./development-workflow.md#setup-inicial)
      - [Configura√ß√£o Docker para Desenvolvimento](./development-workflow.md#configurao-docker-para-desenvolvimento)
      - [Scripts de Desenvolvimento](./development-workflow.md#scripts-de-desenvolvimento)
    - [2. Git Workflow e Branching Strategy](./development-workflow.md#2-git-workflow-e-branching-strategy)
      - [Git Flow Configuration](./development-workflow.md#git-flow-configuration)
      - [Branching Strategy](./development-workflow.md#branching-strategy)
      - [Pre-commit Hooks](./development-workflow.md#pre-commit-hooks)
    - [3. Code Quality e Standards](./development-workflow.md#3-code-quality-e-standards)
      - [ESLint Configuration](./development-workflow.md#eslint-configuration)
      - [Prettier Configuration](./development-workflow.md#prettier-configuration)
      - [TypeScript Configuration](./development-workflow.md#typescript-configuration)
    - [4. Development Tools](./development-workflow.md#4-development-tools)
      - [VSCode Configuration](./development-workflow.md#vscode-configuration)
      - [VSCode Extensions](./development-workflow.md#vscode-extensions)
      - [Debug Configuration](./development-workflow.md#debug-configuration)
    - [5. CI/CD Pipeline](./development-workflow.md#5-cicd-pipeline)
      - [GitHub Actions - Development](./development-workflow.md#github-actions-development)
      - [GitHub Actions - Staging](./development-workflow.md#github-actions-staging)
    - [6. Monitoring de Desenvolvimento](./development-workflow.md#6-monitoring-de-desenvolvimento)
      - [Development Metrics](./development-workflow.md#development-metrics)
      - [Development Dashboard](./development-workflow.md#development-dashboard)
    - [7. Documenta√ß√£o de Desenvolvimento](./development-workflow.md#7-documentao-de-desenvolvimento)
      - [README de Desenvolvimento](./development-workflow.md#readme-de-desenvolvimento)
  - [üèóÔ∏è Arquitetura](#arquitetura)
  - [üß™ Testes](#testes)
  - [üîß Desenvolvimento](#desenvolvimento)
  - [üìù Conven√ß√µes](#convenes)
  - [üöÄ Deploy](#deploy)
  - [üìä Monitoramento](#monitoramento)
