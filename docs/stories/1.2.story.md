# Story 1.2: Estrutura de Banco de Dados CrewAI

## Status

Draft

## Story

**As a** sistema,
**I want** ter tabelas específicas para CrewAI,
**so that** posso armazenar crews, agentes, tarefas e memórias de forma organizada e eficiente.

## Acceptance Criteria

1. Tabela `crews` criada com índices apropriados
2. Tabela `crew_agents` criada para relacionamento
3. Tabela `crew_tasks` criada para tarefas
4. Tabela `crew_memories` criada para memórias
5. Tabela `crew_metrics` criada para métricas
6. Tabelas existentes adaptadas (conversations, messages)
7. Migrações testadas e validadas
8. Índices para performance implementados
9. Constraints para integridade referencial
10. Triggers para automação de dados

## Tasks / Subtasks

- [ ] Task 1: Criar tabelas CrewAI principais (AC: 1, 2, 3, 4, 5)
  - [ ] Criar tabela `crews` com schema completo
  - [ ] Criar tabela `crew_agents` com relacionamentos
  - [ ] Criar tabela `crew_tasks` para execução de tarefas
  - [ ] Criar tabela `crew_memories` para sistema de memória
  - [ ] Criar tabela `crew_metrics` para monitoramento
  - [ ] Implementar constraints e validações

- [ ] Task 2: Adaptar tabelas existentes (AC: 6)
  - [ ] Adicionar campos CrewAI na tabela `conversations`
  - [ ] Adicionar campos CrewAI na tabela `messages`
  - [ ] Manter compatibilidade com sistema existente
  - [ ] Implementar migração segura

- [ ] Task 3: Implementar índices e performance (AC: 8)
  - [ ] Criar índices para queries frequentes
  - [ ] Implementar índices compostos
  - [ ] Otimizar para multi-tenancy
  - [ ] Validar performance com dados de teste

- [ ] Task 4: Configurar integridade referencial (AC: 9)
  - [ ] Implementar foreign keys
  - [ ] Configurar CASCADE rules
  - [ ] Adicionar constraints de validação
  - [ ] Testar integridade com dados

- [ ] Task 5: Implementar triggers e automação (AC: 10)
  - [ ] Trigger para `updated_at` automático
  - [ ] Trigger para validações de negócio
  - [ ] Trigger para auditoria
  - [ ] Testar funcionamento dos triggers

- [ ] Task 6: Criar e testar migrações (AC: 7)
  - [ ] Criar arquivo de migração Drizzle
  - [ ] Implementar rollback seguro
  - [ ] Testar migração em ambiente de desenvolvimento
  - [ ] Validar migração em ambiente de staging
  - [ ] Documentar processo de migração

- [ ] Task 7: Testes unitários
  - [ ] Testes de schema e constraints
  - [ ] Testes de migração
  - [ ] Testes de performance
  - [ ] Testes de integridade referencial
  - [ ] Cobertura de testes > 90%

## Dev Notes

### Previous Story Insights
Baseado na Story 1.1, as dependências CrewAI estão instaladas e a estrutura de diretórios está criada. Esta story implementa a camada de persistência.

### Data Models
Baseado em `docs/architecture/database-schema.md`:

**Tabela `crews`:**
```sql
CREATE TABLE crews (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  company_id UUID NOT NULL REFERENCES companies(id) ON DELETE CASCADE,
  name VARCHAR(255) NOT NULL,
  description TEXT,
  status VARCHAR(50) NOT NULL DEFAULT 'active',
  config JSONB NOT NULL DEFAULT '{}',
  llm_config JSONB NOT NULL DEFAULT '{}',
  memory_config JSONB NOT NULL DEFAULT '{}',
  created_at TIMESTAMP WITH TIME ZONE NOT NULL DEFAULT NOW(),
  updated_at TIMESTAMP WITH TIME ZONE NOT NULL DEFAULT NOW()
);
```
[Source: architecture/database-schema.md#crews-table]

**Tabela `crew_agents`:**
```sql
CREATE TABLE crew_agents (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  crew_id UUID NOT NULL REFERENCES crews(id) ON DELETE CASCADE,
  name VARCHAR(255) NOT NULL,
  role VARCHAR(255) NOT NULL,
  goal TEXT NOT NULL,
  backstory TEXT NOT NULL,
  tools JSONB NOT NULL DEFAULT '[]',
  status VARCHAR(50) NOT NULL DEFAULT 'active',
  config JSONB NOT NULL DEFAULT '{}',
  performance_metrics JSONB NOT NULL DEFAULT '{}',
  created_at TIMESTAMP WITH TIME ZONE NOT NULL DEFAULT NOW(),
  updated_at TIMESTAMP WITH TIME ZONE NOT NULL DEFAULT NOW()
);
```
[Source: architecture/database-schema.md#crew-agents-table]

**Tabela `crew_tasks`:**
```sql
CREATE TABLE crew_tasks (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  crew_id UUID NOT NULL REFERENCES crews(id) ON DELETE CASCADE,
  agent_id UUID NOT NULL REFERENCES crew_agents(id) ON DELETE CASCADE,
  conversation_id UUID NOT NULL REFERENCES conversations(id) ON DELETE CASCADE,
  parent_task_id UUID REFERENCES crew_tasks(id),
  description TEXT NOT NULL,
  expected_output TEXT NOT NULL,
  status VARCHAR(50) NOT NULL DEFAULT 'pending',
  result JSONB,
  error_message TEXT,
  execution_time_ms INTEGER,
  token_usage JSONB,
  cost_usd DECIMAL(10,6),
  metadata JSONB NOT NULL DEFAULT '{}',
  created_at TIMESTAMP WITH TIME ZONE NOT NULL DEFAULT NOW(),
  started_at TIMESTAMP WITH TIME ZONE,
  completed_at TIMESTAMP WITH TIME ZONE
);
```
[Source: architecture/database-schema.md#crew-tasks-table]

### API Specifications
No specific guidance found in architecture docs para esta story de banco de dados.

### Component Specifications
No specific guidance found in architecture docs para esta story de banco de dados.

### File Locations
Baseado em `docs/architecture/source-tree.md`:

**Schema e Migrações:**
- `src/lib/database/schema.ts` - Schema principal [Source: architecture/source-tree.md#database-schema]
- `src/lib/database/migrations/` - Migrações do banco [Source: architecture/source-tree.md#database-migrations]
- `drizzle/` - Arquivos de migração Drizzle [Source: architecture/source-tree.md#drizzle-migrations]

### Testing Requirements
Baseado em `docs/architecture/tech-stack.md`:
- Jest v29+ para testes unitários [Source: architecture/tech-stack.md#testing]
- Cobertura de testes > 90% [Source: architecture/tech-stack.md#testing]
- Testes de migração e rollback
- Testes de performance de queries

### Technical Constraints
Baseado em `docs/architecture/tech-stack.md`:

**Database:**
- PostgreSQL v15+ [Source: architecture/tech-stack.md#database]
- Supabase como provedor [Source: architecture/tech-stack.md#database]
- Drizzle ORM v0.30+ [Source: architecture/tech-stack.md#orm]

**Constraints:**
- Isolamento por tenant obrigatório
- Integridade referencial com CASCADE
- Performance otimizada para multi-tenancy
- Suporte a JSONB para configurações flexíveis

### Project Structure Notes
A estrutura segue exatamente o definido em `docs/architecture/source-tree.md` na seção "Camada de Dados". Não há conflitos identificados.

## Testing

### Testing Standards
Baseado em `docs/architecture/tech-stack.md`:
- **Framework**: Jest v29+ [Source: architecture/tech-stack.md#testing]
- **Location**: `src/lib/database/__tests__/`
- **Pattern**: `*.test.ts`
- **Coverage**: > 90%
- **Database**: PostgreSQL de teste

### Test Cases Required
1. **Teste de Schema**
   - Validar criação de tabelas
   - Verificar constraints
   - Testar índices
   
2. **Teste de Migração**
   - Migração forward
   - Rollback
   - Integridade de dados
   
3. **Teste de Performance**
   - Queries com volume de dados
   - Índices compostos
   - Multi-tenancy
   
4. **Teste de Integridade**
   - Foreign keys
   - CASCADE rules
   - Constraints de validação

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-01-29 | 1.0 | Criação inicial da story seguindo template BMad | Scrum Master |

## Dev Agent Record

### Agent Model Used
_Preencher pelo Dev Agent durante implementação_

### Debug Log References
_Preencher pelo Dev Agent durante implementação_

### Completion Notes List
_Preencher pelo Dev Agent durante implementação_

### File List
_Preencher pelo Dev Agent durante implementação_

## QA Results
_Preencher pelo QA Agent após validação_






