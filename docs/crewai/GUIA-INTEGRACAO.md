# üöÄ Guia Completo de Integra√ß√£o CrewAI + Falachefe

## üìã √çndice

1. [Vis√£o Geral](#vis√£o-geral)
2. [Arquitetura](#arquitetura)
3. [Como Usar](#como-usar)
4. [Exemplos Pr√°ticos](#exemplos-pr√°ticos)
5. [Pr√≥ximos Passos](#pr√≥ximos-passos)
6. [Troubleshooting](#troubleshooting)

---

## üéØ Vis√£o Geral

A integra√ß√£o entre CrewAI e Falachefe permite que agentes de IA especializados realizem opera√ß√µes reais na plataforma, incluindo:

- ‚úÖ Consultar saldo e transa√ß√µes financeiras
- ‚úÖ Registrar despesas e receitas
- ‚úÖ Gerar an√°lises financeiras
- ‚úÖ Enviar mensagens via WhatsApp
- ‚úÖ Orquestrar consultorias multi-disciplinares

### Status da Integra√ß√£o

| Componente | Status | Descri√ß√£o |
|------------|--------|-----------|
| API REST | ‚úÖ Funcionando | Endpoints POST/GET operacionais |
| Tools CrewAI | ‚úÖ Funcionando | 4 ferramentas implementadas |
| Banco de Dados | ‚úÖ Funcionando | PostgreSQL com schema completo |
| LGPD Compliance | ‚úÖ Implementado | userId obrigat√≥rio + audit trail |
| WhatsApp Integration | ‚úÖ Funcionando | Tools UazAPI implementadas |
| Documenta√ß√£o | ‚úÖ Completa | Guias e exemplos dispon√≠veis |

---

## üèóÔ∏è Arquitetura

### Vis√£o Macro

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ                        USU√ÅRIO                              ‚îÇ
‚îÇ                    (via WhatsApp)                           ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                         ‚îÇ
                         ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ                   ORCHESTRATOR AGENT                         ‚îÇ
‚îÇ        (Analisa demanda e direciona para especialista)      ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
    ‚îÇ         ‚îÇ         ‚îÇ         ‚îÇ         ‚îÇ
    ‚ñº         ‚ñº         ‚ñº         ‚ñº         ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇFinance‚îÇ ‚îÇMarketing‚îÇ ‚îÇSales  ‚îÇ ‚îÇ  HR  ‚îÇ ‚îÇ Support ‚îÇ
‚îÇExpert ‚îÇ ‚îÇ Expert  ‚îÇ ‚îÇExpert ‚îÇ ‚îÇExpert‚îÇ ‚îÇ  Agent  ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îò ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îò
    ‚îÇ                                          ‚îÇ
    ‚ñº                                          ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê              ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ   CASHFLOW TOOLS      ‚îÇ              ‚îÇ  UAZAPI      ‚îÇ
‚îÇ  - AddTransaction     ‚îÇ              ‚îÇ  TOOLS       ‚îÇ
‚îÇ  - GetBalance         ‚îÇ              ‚îÇ              ‚îÇ
‚îÇ  - GetCategories      ‚îÇ              ‚îÇ              ‚îÇ
‚îÇ  - GetSummary         ‚îÇ              ‚îÇ              ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò              ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
        ‚îÇ
        ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ              FALACHEFE API REST                      ‚îÇ
‚îÇ      POST /api/financial/transactions               ‚îÇ
‚îÇ      GET  /api/financial/transactions               ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                        ‚îÇ
                        ‚ñº
                ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
                ‚îÇ  PostgreSQL   ‚îÇ
                ‚îÇ  financial_   ‚îÇ
                ‚îÇ  data table   ‚îÇ
                ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

### Fluxo de Dados Detalhado

```mermaid
sequenceDiagram
    participant U as Usu√°rio
    participant O as Orchestrator
    participant FE as Financial Expert
    participant T as Cashflow Tool
    participant API as Falachefe API
    participant DB as PostgreSQL
    
    U->>O: "Registre uma despesa de R$ 5.000"
    O->>O: Analisa demanda
    O->>FE: Delega para Financial Expert
    FE->>FE: Processa requisi√ß√£o
    FE->>T: Chama AddCashflowTransactionTool()
    T->>API: POST /api/financial/transactions
    API->>API: Valida userId (LGPD)
    API->>DB: INSERT INTO financial_data
    DB-->>API: Transaction criada (UUID)
    API-->>T: Status 200 + dados
    T-->>FE: "Transa√ß√£o registrada com sucesso"
    FE-->>O: Relat√≥rio formatado
    O-->>U: Confirma√ß√£o + an√°lise
```

---

## üöÄ Como Usar

### Pr√©-requisitos

```bash
# 1. Servidor Next.js rodando
cd /Users/tiagoyokoyama/Falachefe
npm run dev

# 2. PostgreSQL ativo
# Verificar conex√£o em localhost:5432

# 3. Vari√°veis de ambiente configuradas
# .env.local no projeto principal
# .env no projeto CrewAI
```

### Configura√ß√£o Inicial

#### 1. Vari√°veis de Ambiente (CrewAI)

```bash
# crewai-projects/falachefe_crew/.env

# OpenAI
OPENAI_API_KEY=sk-proj-...
MODEL=gpt-4o-mini

# API Falachefe
FALACHEFE_API_URL=http://localhost:3000

# UazAPI (WhatsApp)
UAZAPI_INSTANCE_ID=seu_instance_id
UAZAPI_TOKEN=seu_token
```

#### 2. Instala√ß√£o de Depend√™ncias

```bash
cd crewai-projects/falachefe_crew

# Criar ambiente virtual
python -m venv .venv
source .venv/bin/activate  # Linux/Mac
# ou
.venv\Scripts\activate     # Windows

# Instalar depend√™ncias
pip install -r requirements.txt
```

---

## üí° Exemplos Pr√°ticos

### Exemplo 1: Consulta Simples de Saldo

```python
from falachefe_crew.tools.cashflow_tools import GetCashflowBalanceTool

# Criar inst√¢ncia
tool = GetCashflowBalanceTool()

# Consultar saldo do m√™s
result = tool._run(
    user_id="test_empresa",
    period="month"
)

print(result)
# Sa√≠da:
# üí∞ Saldo Atual do Fluxo de Caixa
# üìä Per√≠odo: √öltimos 30 dias
# 
# ‚úÖ Entradas: R$ 25,000.00
# ‚ùå Sa√≠das: R$ 18,000.00
# üíµ Saldo: R$ 7,000.00
```

### Exemplo 2: Registrar Nova Transa√ß√£o

```python
from falachefe_crew.tools.cashflow_tools import AddCashflowTransactionTool

tool = AddCashflowTransactionTool()

# Registrar despesa
result = tool._run(
    user_id="test_empresa",        # ‚ö†Ô∏è OBRIGAT√ìRIO
    transaction_type="saida",
    amount=5000.00,
    category="aluguel",
    description="Aluguel escrit√≥rio - Outubro 2025",
    date="2025-10-08"
)

# ‚úÖ Transa√ß√£o salva no PostgreSQL
```

### Exemplo 3: Crew Orquestrada (RECOMENDADO)

```python
from falachefe_crew.crew import FalachefeCrew

# Criar crew
crew = FalachefeCrew()
orchestrated = crew.orchestrated_crew()

# Input do usu√°rio
inputs = {
    "user_message": """
        Preciso de uma an√°lise completa:
        1. Qual meu saldo atual?
        2. Quais s√£o as principais despesas?
        3. Como posso reduzir custos em 20%?
    """,
    "user_id": "test_empresa",
    "phone_number": "+5511999999999"
}

# Executar (o orchestrator vai coordenar tudo)
result = orchestrated.kickoff(inputs=inputs)

# O orchestrator ir√°:
# 1. Analisar a demanda
# 2. Delegar para Financial Expert
# 3. Compilar an√°lise completa com recomenda√ß√µes
```

### Exemplo 4: Consultoria Multi-Agente

```python
# Cen√°rio: Empresa quer expandir e precisa de ajuda
# em Finan√ßas, Marketing e RH

inputs = {
    "user_message": """
        Quero expandir meu neg√≥cio:
        - Tenho R$ 100.000 em caixa
        - Quero contratar 3 pessoas
        - Preciso aumentar vendas em 50%
        
        Me ajude com:
        1. Viabilidade financeira
        2. Estrat√©gia de marketing digital
        3. Processo de contrata√ß√£o adequado
    """,
    "user_id": "empresa_xyz",
    "phone_number": "+5511999999999"
}

result = orchestrated.kickoff(inputs=inputs)

# O orchestrator ir√° delegar para:
# 1. Financial Expert ‚Üí An√°lise de viabilidade
# 2. Marketing Expert ‚Üí Estrat√©gia de growth
# 3. HR Expert ‚Üí Processo de contrata√ß√£o
# 4. Compilar resposta integrada
```

---

## üîß Estrutura de Tools Dispon√≠veis

### Cashflow Tools

| Tool | Fun√ß√£o | Endpoint |
|------|--------|----------|
| `AddCashflowTransactionTool` | Registrar transa√ß√£o | `POST /api/financial/transactions` |
| `GetCashflowBalanceTool` | Consultar saldo | `GET /api/financial/transactions` |
| `GetCashflowCategoriesTool` | Listar categorias | Mock (pronto para API) |
| `GetCashflowSummaryTool` | Resumo completo | Mock (pronto para API) |

### WhatsApp Tools (UazAPI)

| Tool | Fun√ß√£o |
|------|--------|
| `SendTextMessageTool` | Enviar mensagem de texto |
| `SendMenuMessageTool` | Enviar menu interativo |
| `SendMediaMessageTool` | Enviar m√≠dia (PDF, imagem) |
| `GetChatDetailsTool` | Obter detalhes do chat |
| `UpdateLeadInfoTool` | Atualizar info do lead |
| `FormatResponseTool` | Formatar resposta |

---

## üìä Schema do Banco de Dados

### Tabela: financial_data

```sql
CREATE TABLE financial_data (
  id              UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id         VARCHAR(100) NOT NULL,   -- ‚ö†Ô∏è OBRIGAT√ìRIO (LGPD)
  type            VARCHAR(20) NOT NULL,     -- 'entrada' ou 'saida'
  amount          INTEGER NOT NULL,         -- Valor em centavos
  description     TEXT NOT NULL,
  category        VARCHAR(50) NOT NULL,
  date            TIMESTAMP NOT NULL,
  metadata        JSONB DEFAULT '{}',       -- Audit trail
  created_at      TIMESTAMP DEFAULT NOW(),
  updated_at      TIMESTAMP DEFAULT NOW()
);

-- √çndices para performance
CREATE INDEX idx_financial_data_user_id ON financial_data(user_id);
CREATE INDEX idx_financial_data_date ON financial_data(date);
CREATE INDEX idx_financial_data_type ON financial_data(type);
```

### Exemplo de Metadata (Audit Trail)

```json
{
  "source": "crewai",
  "agent": "financial_expert",
  "createdBy": "test_empresa",
  "createdByEmail": "empresa@example.com",
  "createdAt": "2025-10-08T20:00:00Z",
  "ipAddress": "192.168.1.100",
  "userAgent": "CrewAI Financial Agent/1.0"
}
```

---

## üîê LGPD Compliance

### Prote√ß√µes Implementadas

1. **userId Obrigat√≥rio**
   - Todas as opera√ß√µes exigem userId
   - Valida√ß√£o em API e Tools
   
2. **Isolamento de Dados**
   - Usu√°rio s√≥ acessa seus pr√≥prios dados
   - Filtros autom√°ticos por userId

3. **Audit Trail Completo**
   - Logs de todas opera√ß√µes
   - Metadata com createdBy, timestamp, IP
   - Rastreabilidade completa

4. **Autentica√ß√£o**
   - Session obrigat√≥ria via Better Auth
   - Valida√ß√£o de acesso

### Exemplo de Valida√ß√£o

```typescript
// API valida automaticamente
if (!userId) {
  return NextResponse.json(
    { success: false, error: "userId √© obrigat√≥rio" },
    { status: 400 }
  );
}

// Usu√°rio s√≥ acessa seus dados
const transactions = await db.query(`
  SELECT * FROM financial_data 
  WHERE user_id = $1
`, [userId]);
```

---

## üéØ Pr√≥ximos Passos

### Curto Prazo (Implementado)

- [x] API REST funcionando
- [x] Tools integradas
- [x] LGPD compliance
- [x] Documenta√ß√£o completa

### M√©dio Prazo (Planejado)

- [ ] Implementar GET de categorias com dados reais
- [ ] Implementar GET de summary com dados reais
- [ ] Adicionar cache para otimizar consultas
- [ ] Implementar pagina√ß√£o na listagem

### Longo Prazo (Roadmap)

- [ ] DELETE - Direito de exclus√£o (LGPD)
- [ ] PATCH - Direito de corre√ß√£o (LGPD)
- [ ] Export - Direito de portabilidade (LGPD)
- [ ] Webhooks para sincroniza√ß√£o em tempo real
- [ ] Dashboard de m√©tricas
- [ ] Notifica√ß√µes proativas

---

## üêõ Troubleshooting

### Problema: Conex√£o Recusada

```bash
‚ùå Erro: N√£o foi poss√≠vel conectar √† API em http://localhost:3000
```

**Solu√ß√£o:**
```bash
# Verificar se o servidor est√° rodando
cd /Users/tiagoyokoyama/Falachefe
npm run dev

# Deve mostrar:
# ‚úì Ready on http://localhost:3000
```

### Problema: userId √© obrigat√≥rio

```bash
‚ùå Erro 400: userId √© obrigat√≥rio
```

**Solu√ß√£o:**
```python
# SEMPRE passar userId
tool._run(
    user_id="test_empresa",  # ‚ö†Ô∏è OBRIGAT√ìRIO
    transaction_type="saida",
    amount=5000.00
)
```

### Problema: Transa√ß√£o n√£o aparece no banco

**Verificar:**

```bash
# Conectar ao PostgreSQL
psql -U postgres -d falachefe

# Consultar transa√ß√µes
SELECT 
  id, 
  user_id, 
  type, 
  amount / 100.0 as amount_reais,
  category,
  description,
  date
FROM financial_data
ORDER BY created_at DESC
LIMIT 10;
```

### Problema: OpenAI API Key inv√°lida

```bash
‚ùå Erro: Invalid API Key
```

**Solu√ß√£o:**
```bash
# Verificar .env
cd crewai-projects/falachefe_crew
cat .env | grep OPENAI

# Deve ter:
# OPENAI_API_KEY=sk-proj-...

# Se n√£o tiver, adicionar:
echo "OPENAI_API_KEY=sua-chave-aqui" >> .env
```

---

## üìö Refer√™ncias

- [README-INTEGRACAO-API.md](../../crewai-projects/falachefe_crew/README-INTEGRACAO-API.md) - Guia detalhado da API
- [RESUMO-INTEGRACAO.md](../../crewai-projects/falachefe_crew/RESUMO-INTEGRACAO.md) - Resumo executivo
- [LGPD-COMPLIANCE.md](../../crewai-projects/falachefe_crew/LGPD-COMPLIANCE.md) - Detalhes de compliance
- [cashflow_tools.py](../../crewai-projects/falachefe_crew/src/falachefe_crew/tools/cashflow_tools.py) - C√≥digo das tools
- [crewai_falachefe_integracao.md](./crewai_falachefe_integracao.md) - Guia arquitet√¥nico completo

---

## üÜò Suporte

Em caso de problemas:

1. Verificar logs do Next.js (`npm run dev`)
2. Verificar logs do CrewAI
3. Consultar documenta√ß√£o LGPD-COMPLIANCE.md
4. Testar com script de exemplo: `python exemplo_integracao_completa.py`

---

**Status**: ‚úÖ Integra√ß√£o Completa e Funcional  
**√öltima atualiza√ß√£o**: 08/10/2025  
**Vers√£o**: 1.0.0  
**Compliance LGPD**: ‚úÖ Sim

